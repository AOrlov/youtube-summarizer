<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Summarizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .summary-container {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .summary-container pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
        }

        .summary-container code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }

        .transcript-container {
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            padding: 1rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 450px;
            overflow-y: auto;
            font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .results-card {
            transition: box-shadow 0.2s ease;
        }

        .results-card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">YouTube Video Summarizer</h1>

        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <form id="summarizeForm">
                            <div class="mb-3">
                                <label for="videoUrl" class="form-label">YouTube Video URL</label>
                                <input type="url" class="form-control" id="videoUrl" required>
                            </div>
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                <button type="submit" class="btn btn-primary">Summarize</button>
                                <small class="text-muted">You will always get the full transcript for copying.</small>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="alert alert-danger mt-4 d-none" id="errorAlert"></div>

                <div class="card mt-4 results-card shadow-sm d-none" id="resultCard">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                            <div>
                                <h5 class="mb-1">Summary</h5>
                                <p class="text-muted small mb-0">Generated with Gemini when available.</p>
                            </div>
                            <span class="badge bg-secondary d-none" id="languageBadge"></span>
                        </div>

                        <div class="alert alert-warning d-none" id="summaryNotice"></div>

                        <div class="summary-container" id="summary"></div>

                        <hr class="my-4">

                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                            <div>
                                <h5 class="mb-1">Transcript</h5>
                                <p class="text-muted small mb-0">Copy/paste here if the summary API is rate-limited.</p>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="copyTranscriptBtn">
                                Copy transcript
                            </button>
                        </div>

                        <div class="transcript-container" id="transcript"></div>
                    </div>
                </div>

                <div class="card mt-4" id="progressCard" style="display: none;">
                    <div class="card-body">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                style="width: 100%"></div>
                        </div>
                        <p class="text-center mt-2 mb-0">Fetching transcript and summary...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const summarizeForm = document.getElementById('summarizeForm');
        const videoUrlInput = document.getElementById('videoUrl');
        const resultCard = document.getElementById('resultCard');
        const progressCard = document.getElementById('progressCard');
        const summaryElement = document.getElementById('summary');
        const transcriptElement = document.getElementById('transcript');
        const copyTranscriptBtn = document.getElementById('copyTranscriptBtn');
        const languageBadge = document.getElementById('languageBadge');
        const summaryNotice = document.getElementById('summaryNotice');
        const errorAlert = document.getElementById('errorAlert');

        const setLoading = (isLoading) => {
            progressCard.style.display = isLoading ? 'block' : 'none';
        };

        const resetUI = () => {
            errorAlert.classList.add('d-none');
            resultCard.classList.add('d-none');
            summaryNotice.classList.add('d-none');
            languageBadge.classList.add('d-none');
            summaryElement.innerHTML = '';
            transcriptElement.textContent = '';
            copyTranscriptBtn.disabled = true;
            copyTranscriptBtn.textContent = 'Copy transcript';
        };

        const canUseAsyncClipboard = () =>
            Boolean(window.isSecureContext && navigator.clipboard?.writeText);

        const legacyCopy = (text) => {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                return success;
            } catch (error) {
                console.error('Fallback clipboard copy failed.', error);
                return false;
            }
        };

        const copyTextToClipboard = async (text) => {
            if (!text) {
                return false;
            }

            if (canUseAsyncClipboard()) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (error) {
                    console.warn('Clipboard API failed, falling back to execCommand copy.', error);
                }
            }

            return legacyCopy(text);
        };

        const renderResult = (data) => {
            const hasSummary = Boolean(data.summary);
            const hasTranscript = Boolean(data.transcript);

            if (hasSummary) {
                summaryElement.innerHTML = marked.parse(data.summary);
            } else {
                summaryElement.innerHTML = '<p class="text-muted mb-0">Summary is unavailable. Use the transcript below.</p>';
            }

            if (data.summary_error) {
                summaryNotice.textContent = `Summary unavailable: ${data.summary_error}`;
                summaryNotice.classList.remove('d-none');
            }

            transcriptElement.textContent = hasTranscript ? data.transcript : 'Transcript unavailable.';
            copyTranscriptBtn.disabled = !hasTranscript;

            if (data.language) {
                languageBadge.textContent = `Language: ${data.language}`;
                languageBadge.classList.remove('d-none');
            }

            resultCard.classList.remove('d-none');
        };

        summarizeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const videoUrl = videoUrlInput.value.trim();

            if (!videoUrl) {
                return;
            }

            resetUI();
            setLoading(true);

            try {
                const response = await fetch('/api/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        video_url: videoUrl
                    })
                });

                const data = await response.json();

                if (!response.ok || data.status === 'error') {
                    throw new Error(data.error || `Request failed with status ${response.status}`);
                }

                renderResult(data);
            } catch (error) {
                errorAlert.textContent = error.message || 'An error occurred while processing your request.';
                errorAlert.classList.remove('d-none');
            } finally {
                setLoading(false);
            }
        });

        copyTranscriptBtn.addEventListener('click', async () => {
            const transcriptText = transcriptElement.textContent;

            const copied = await copyTextToClipboard(transcriptText);
            copyTranscriptBtn.textContent = copied ? 'Copied!' : 'Copy failed';

            setTimeout(() => {
                copyTranscriptBtn.textContent = 'Copy transcript';
            }, 1500);
        });

        const initializeFromQuery = () => {
            const params = new URLSearchParams(window.location.search);
            const prefilledUrl = params.get('video_url') || params.get('video');

            if (!prefilledUrl) {
                return;
            }

            try {
                videoUrlInput.value = decodeURIComponent(prefilledUrl);
            } catch (error) {
                videoUrlInput.value = prefilledUrl;
            }

            // Trigger summarization automatically when coming from the extension
            summarizeForm.dispatchEvent(new Event('submit', { cancelable: true }));
        };

        initializeFromQuery();
    </script>
</body>

</html>
